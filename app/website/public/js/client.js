// Generated by CoffeeScript 1.3.1
(function() {
  var Client;

  window.DEBUG = true;

  Client = (function() {

    Client.name = 'Client';

    function Client() {
      var href, link, needsLogin, url, _i, _len;
      if (!loggedIn) {
        needsLogin = $('.needs-session');
        for (_i = 0, _len = needsLogin.length; _i < _len; _i++) {
          link = needsLogin[_i];
          link = $(link);
          href = link.attr('href');
          url = href !== '#' ? href : void 0;
          this.createLoginLink(url, link);
        }
      }
    }

    Client.prototype.initFB = function(FB) {
      this.FB = FB;
    };

    Client.prototype.createLoginLink = function(url, selector) {
      var _this = this;
      return $(selector).click(function() {
        var callback;
        if (!loggedIn) {
          if (DEBUG && /http(s?):\/\/local\./.test(window.location.href)) {
            callback = function(response) {
              var _this = this;
              if (response.authResponse) {
                return this.FB.api('/me', function(userDetails) {
                  return $.post('/addSession_INSECURE', {
                    domain: 'facebook',
                    response: response,
                    userDetails: userDetails
                  }, function() {
                    if (url) {
                      return window.location.href = url;
                    } else {
                      return window.location.reload();
                    }
                  });
                });
              }
            };
            _this.FB.login(callback, {
              scope: 'email,user_location'
            });
            return false;
          } else {
            callback = function(response) {
              var _this = this;
              if (response.authResponse) {
                return $.post('/addSession', {
                  domain: 'facebook',
                  response: response
                }, function() {
                  if (url) {
                    return window.location.href = url;
                  } else {
                    return window.location.reload();
                  }
                });
              }
            };
            _this.FB.login(callback, {
              scope: 'email,user_location'
            });
            return false;
          }
        } else {
          return window.location.href = url;
        }
      });
    };

    return Client;

  })();

  this.SocialTypist.Client = Client;

}).call(this);
